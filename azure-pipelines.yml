trigger:
  branches:
    include:
      - main

pool:
  name: 'local-lab'
  vmImage: 'ubuntu-latest'

resources:
  pipelines:
    - pipeline: cluster-base
      source: ParksBra.home-k8s-cluster-base

  repositories:
    - repository: templates
      type: github
      endpoint: ParksBra
      ref: initial_development
      name: ParksBra/home-k8s-ado-templates

variables:
  - group: home-k8s-ssh

stages:
  - stage: "platformStoragePrerequisites"
    displayName: "Platform Storage Prerequisites"
    variables:
      - group: home-k8s-cluster
    jobs:
      - job: "ansibleApplyPlatformStoragePrerequisites"
        displayName: "Ansible Apply Platform Storage Prerequisites"
        steps:
          - template: apply-ansible.yml@templates
            parameters:
              pythonVenvPath: "$(System.DefaultWorkingDirectory)/.venv"
              pythonVenvCacheVersion: "1"
              pythonRequirementsFileRelativePath: "requirements.txt"
              ansibleRequirementsFileRelativePath: "requirements.yml"
              ansibleRepository: "self"
              ansibleRepositoryAnsiblePath: "ansible"
              ansibleConfigRelativePath: "ansible.cfg"
              ansibleSshConfigurations:
                - group: k8s_controller
                  user: controller
                  keySecretFileName: "$(home-k8s-ssh-controller-key-secret-file)"
                  keyPassphrase: ""
              ansiblePlaybooks:
                - site.yml
              ansibleDebug: false
              ansiblePlaybookExtraEnvironmentVariables: {}

  - stage: "platformStorageDeployment"
    displayName: "Platform Storage Deployment"
    dependsOn: "platformStoragePrerequisites"
    variables:
      - group: home-k8s-cluster
      - group: home-k8s-terraform
    jobs:
      - job: "terraformApplyPlatformStorage"
        displayName: "Terraform Apply Platform Storage"
        steps:
          - template: apply-terraform.yml@templates
            parameters:
              kubeconfigArtifactFileName: "kubeconfig"
              kubeconfigArtifactName: "kubeConfig"
              kubeconfigArtifactSourcePipeline: "cluster-base"
              terraformRepository: "self"
              terraformRepositoryTerraformPath: "terraform"
              terraformVersion: "latest"
              terraformBackendNamespace: "kube-system"
              terraformBackendSuffix: "platform-storage"
              terraformExtraEnvironmentVariables:
                - name: TF_VAR_azuredevops_library_name
                  value: "home-k8s-cluster"
                - name: TF_VAR_azuredevops_library_project_id
                  value: "$(System.TeamProjectId)"
                - name: AZDO_PERSONAL_ACCESS_TOKEN
                  value: "$(System.AccessToken)"
                - name: AZDO_ORG_SERVICE_URL
                  value: "$(System.TeamFoundationCollectionUri)"
                - name: CLOUDFLARE_API_TOKEN
                  value: "$(home-k8s-terraform-provider-cloudflare-api-token)"
              terraformValidate: true
              terraformPlanDestroy: false
              terraformApply: true
